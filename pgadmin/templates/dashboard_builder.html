<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ module.name }} - Dashboard Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:#1a1b1e;color:#ececf1;height:100vh;overflow:hidden}
        
        .dashboard-container{display:flex;height:100vh}
        
        /* Sidebar */
        .sidebar{width:280px;background:#25262b;border-right:1px solid #373a40;display:flex;flex-direction:column;padding:12px;gap:10px}
        .sidebar-header{padding:10px;border-bottom:1px solid #373a40}
        .sidebar-title{font-size:14px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px}
        .new-dashboard-btn{width:100%;padding:10px;border-radius:8px;border:1px solid #5c5f66;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;cursor:pointer;font-size:13px;font-weight:600;margin-top:10px;transition:all 0.2s}
        .new-dashboard-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(102,126,234,0.4)}
        
        .module-info{padding:12px;background:#2c2e33;border-radius:8px;font-size:12px;color:#909296}
        .module-name{font-weight:700;color:#fff;margin-bottom:4px;font-size:14px}
        
        .dashboards-section{flex:1;overflow-y:auto;margin-top:10px}
        .section-label{font-size:11px;font-weight:700;color:#909296;text-transform:uppercase;letter-spacing:0.5px;padding:8px 4px}
        .dashboard-item{padding:12px;margin-bottom:6px;border-radius:8px;cursor:pointer;transition:all 0.15s;font-size:13px;background:#2c2e33;border:1px solid transparent;position:relative}
        .dashboard-item:hover{background:#373a40;border-color:#5c5f66}
        .dashboard-item.active{background:linear-gradient(135deg,#667eea20 0%,#764ba220 100%);border-color:#667eea}
        .dashboard-item-title{font-weight:600;color:#fff;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .dashboard-item-meta{font-size:11px;color:#909296}
        .delete-dashboard-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:#909296;cursor:pointer;padding:4px;border-radius:4px;opacity:0;transition:opacity 0.15s}
        .dashboard-item:hover .delete-dashboard-btn{opacity:1}
        .delete-dashboard-btn:hover{color:#ff6b6b}
        
        .sidebar-footer{padding:10px;border-top:1px solid #373a40}
        .back-btn{width:100%;padding:10px;border-radius:8px;border:1px solid #5c5f66;color:#ececf1;background:transparent;text-decoration:none;display:block;text-align:center;font-weight:600;font-size:13px;transition:all 0.15s}
        .back-btn:hover{background:#373a40}
        
        /* Main Area */
        .main-area{flex:1;display:flex;flex-direction:column;min-width:0}
        
        /* Header */
        .main-header{padding:16px 24px;border-bottom:1px solid #373a40;background:#25262b;display:flex;align-items:center;justify-content:space-between}
        .header-left{display:flex;align-items:center;gap:12px}
        .header-title{font-size:18px;font-weight:700}
        .header-badge{padding:4px 10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:20px;font-size:11px;font-weight:600}
        .header-actions{display:flex;gap:8px}
        .header-btn{padding:8px 16px;border-radius:8px;border:1px solid #5c5f66;background:transparent;color:#ececf1;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.15s;display:flex;align-items:center;gap:6px}
        .header-btn:hover{background:#373a40}
        .header-btn.primary{background:linear-gradient(135deg,#10b981 0%,#059669 100%);border:none}
        .header-btn.primary:hover{box-shadow:0 4px 12px rgba(16,185,129,0.4)}
        
        /* Filters Bar */
        .filters-bar{padding:12px 24px;background:#2c2e33;border-bottom:1px solid #373a40;display:none}
        .filters-bar.show{display:block}
        .filters-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .filters-title{font-size:13px;font-weight:600;color:#fff;display:flex;align-items:center;gap:8px}
        .add-filter-btn{padding:6px 12px;border-radius:6px;border:1px dashed #5c5f66;background:transparent;color:#909296;cursor:pointer;font-size:12px;transition:all 0.15s}
        .add-filter-btn:hover{border-color:#667eea;color:#667eea}
        .filters-container{display:flex;flex-wrap:wrap;gap:10px}
        .filter-chip{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#373a40;border-radius:8px;border:1px solid #5c5f66}
        .filter-chip select{background:#2c2e33;border:1px solid #5c5f66;border-radius:4px;color:#ececf1;padding:4px 8px;font-size:12px;min-width:120px}
        .filter-chip .remove-filter{background:none;border:none;color:#909296;cursor:pointer;padding:2px;font-size:14px}
        .filter-chip .remove-filter:hover{color:#ef4444}
        .filter-label{font-size:11px;color:#909296;font-weight:600}
        
        /* Filter Modal */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000}
        .modal-overlay.show{display:flex}
        .modal{background:#25262b;border-radius:12px;border:1px solid #373a40;width:90%;max-width:500px;max-height:80vh;overflow:hidden}
        .modal-header{padding:16px 20px;border-bottom:1px solid #373a40;display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:16px;font-weight:700}
        .modal-close{background:none;border:none;color:#909296;cursor:pointer;font-size:20px}
        .modal-body{padding:20px;max-height:60vh;overflow-y:auto}
        .modal-footer{padding:16px 20px;border-top:1px solid #373a40;display:flex;justify-content:flex-end;gap:10px}
        
        .column-list{display:flex;flex-direction:column;gap:8px}
        .column-item{display:flex;align-items:center;gap:12px;padding:10px;background:#2c2e33;border-radius:8px;cursor:pointer;transition:all 0.15s;border:1px solid transparent}
        .column-item:hover{background:#373a40}
        .column-item.selected{background:#667eea30;border-color:#667eea}
        .column-item input[type="checkbox"]{width:18px;height:18px}
        .column-info{flex:1}
        .column-name{font-size:13px;font-weight:600;color:#fff}
        .column-table{font-size:11px;color:#909296}
        
        /* Dashboard Canvas */
        .dashboard-canvas{flex:1;overflow-y:auto;padding:24px;background:#1a1b1e}
        
        /* Empty State */
        .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#909296}
        .empty-icon{font-size:64px;margin-bottom:16px;opacity:0.5}
        .empty-title{font-size:20px;font-weight:600;color:#fff;margin-bottom:8px}
        .empty-desc{font-size:14px;text-align:center;max-width:400px;line-height:1.6}
        
        /* Dashboard Grid */
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));gap:20px}
        
        /* Widget Card */
        .widget-card{background:#25262b;border-radius:12px;border:1px solid #373a40;overflow:hidden;transition:all 0.2s}
        .widget-card:hover{border-color:#5c5f66;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
        .widget-header{padding:16px;border-bottom:1px solid #373a40;display:flex;justify-content:space-between;align-items:center}
        .widget-title{font-size:14px;font-weight:600;color:#fff}
        .widget-actions{display:flex;gap:4px}
        .widget-btn{padding:6px;border-radius:6px;border:none;background:transparent;color:#909296;cursor:pointer;transition:all 0.15s}
        .widget-btn:hover{background:#373a40;color:#fff}
        .widget-content{padding:16px;min-height:200px}
        
        /* Chart Styles */
        .chart-container{position:relative;height:250px}
        
        /* KPI Card */
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:16px}
        .kpi-card{background:#2c2e33;border-radius:10px;padding:20px;text-align:center}
        .kpi-value{font-size:28px;font-weight:700;color:#fff;margin-bottom:4px}
        .kpi-label{font-size:12px;color:#909296;text-transform:uppercase;letter-spacing:0.5px}
        .kpi-change{font-size:12px;margin-top:8px;padding:4px 8px;border-radius:20px;display:inline-block}
        .kpi-change.positive{background:#10b98120;color:#10b981}
        .kpi-change.negative{background:#ef444420;color:#ef4444}
        
        /* Data Table */
        .data-table-container{overflow-x:auto;max-height:300px}
        .data-table{width:100%;border-collapse:collapse;font-size:13px}
        .data-table th{text-align:left;padding:12px;font-weight:600;color:#909296;background:#2c2e33;position:sticky;top:0;border-bottom:1px solid #373a40}
        .data-table td{padding:12px;color:#ececf1;border-bottom:1px solid #373a4050}
        .data-table tr:hover td{background:#2c2e33}
        
        /* Input Area */
        .input-area{padding:16px 24px;background:#25262b;border-top:1px solid #373a40}
        .input-wrapper{max-width:1200px;margin:0 auto;position:relative}
        .input-box{width:100%;padding:14px 50px 14px 16px;background:#2c2e33;border:1px solid #373a40;border-radius:12px;color:#ececf1;font-size:14px;resize:none;transition:all 0.15s}
        .input-box:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px #667eea30}
        .input-box::placeholder{color:#909296}
        .send-btn{position:absolute;right:8px;bottom:8px;width:40px;height:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;border-radius:10px;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s}
        .send-btn:hover{transform:scale(1.05)}
        .send-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        
        /* Loading */
        .loading-spinner{width:40px;height:40px;border:3px solid #373a40;border-top-color:#667eea;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Prompt Suggestions */
        .prompt-suggestions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
        .suggestion-chip{padding:8px 14px;background:#2c2e33;border:1px solid #373a40;border-radius:20px;font-size:12px;color:#ececf1;cursor:pointer;transition:all 0.15s}
        .suggestion-chip:hover{border-color:#667eea;background:#373a40}
        
        ::-webkit-scrollbar{width:8px;height:8px}
        ::-webkit-scrollbar-track{background:#1a1b1e}
        ::-webkit-scrollbar-thumb{background:#373a40;border-radius:4px}
        ::-webkit-scrollbar-thumb:hover{background:#5c5f66}
        
        @media(max-width:768px){.sidebar{display:none}.dashboard-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">üìä Dashboard Builder</div>
                <button class="new-dashboard-btn" onclick="createNewDashboard()">+ New Dashboard</button>
            </div>
            <div class="module-info">
                <div class="module-name">{{ module.name }}</div>
                <div>{{ module.tables|length }} tables available</div>
            </div>
            <div class="dashboards-section">
                <div class="section-label">Saved Dashboards</div>
                <div id="dashboardsList"><div style="padding:20px;text-align:center;color:#909296;font-size:13px">Loading...</div></div>
            </div>
            <div class="sidebar-footer">
                <a href="{% url 'edit_module' module.id %}" class="back-btn">‚Üê Back to Module</a>
            </div>
        </div>
        
        <div class="main-area">
            <div class="main-header">
                <div class="header-left">
                    <h1 class="header-title" id="dashboardTitle">New Dashboard</h1>
                    <span class="header-badge">AI Powered</span>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="toggleFilters()">üéõÔ∏è Filters</button>
                    <button class="header-btn" onclick="refreshDashboard()">üîÑ Refresh</button>
                    <button class="header-btn" onclick="exportDashboard()">üì§ Export</button>
                    <button class="header-btn primary" onclick="saveDashboard()">üíæ Save</button>
                </div>
            </div>
            
            <div class="filters-bar" id="filtersBar">
                <div class="filters-header">
                    <div class="filters-title">üéõÔ∏è Dashboard Filters / Slicers</div>
                    <button class="add-filter-btn" onclick="openFilterModal()">+ Add Filter</button>
                </div>
                <div class="filters-container" id="filtersContainer">
                    <div style="color:#909296;font-size:13px;padding:8px;">No filters added. Click "Add Filter" to create slicers.</div>
                </div>
            </div>
            
            <div class="dashboard-canvas" id="dashboardCanvas">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">üìä</div>
                    <div class="empty-title">Create Your Dashboard</div>
                    <div class="empty-desc">Describe what you want to visualize and AI will generate interactive charts and widgets.</div>
                    <div class="prompt-suggestions">
                        <div class="suggestion-chip" onclick="usePrompt('Show sales overview with KPIs and monthly trend')">üìà Sales Overview</div>
                        <div class="suggestion-chip" onclick="usePrompt('Create distributor performance dashboard')">üè™ Distributor Performance</div>
                        <div class="suggestion-chip" onclick="usePrompt('Product wise sales comparison with pie chart')">ü•ß Product Comparison</div>
                        <div class="suggestion-chip" onclick="usePrompt('Regional sales analysis with top performers')">üó∫Ô∏è Regional Analysis</div>
                    </div>
                </div>
                <div class="dashboard-grid" id="dashboardGrid" style="display:none"></div>
            </div>
            
            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="promptInput" class="input-box" placeholder="Describe your dashboard... e.g., 'Show monthly sales trend with top 5 products'" rows="1" onkeydown="handleKeyPress(event)"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="generateDashboard()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="filterModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add Filter / Slicer</div>
                <button class="modal-close" onclick="closeFilterModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color:#909296;font-size:13px;margin-bottom:16px;">Select columns to use as filters. These will appear as dropdown slicers.</p>
                <div class="column-list" id="columnList"></div>
            </div>
            <div class="modal-footer">
                <button class="header-btn" onclick="closeFilterModal()">Cancel</button>
                <button class="header-btn primary" onclick="applySelectedFilters()">Add Selected</button>
            </div>
        </div>
    </div>

<script>
const MODULE_ID = {{ module.id }};
let MODULE_TABLES = [];
try { MODULE_TABLES = {{ module.tables|safe }}; } catch(e) { MODULE_TABLES = []; }

let currentDashboardId = null;
let currentWidgets = [];
let currentFilters = [];
let filterValues = {};
let availableColumns = [];
let isGenerating = false;
let chartInstances = {};
let selectedFilterColumns = new Set();

document.getElementById('promptInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

function handleKeyPress(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generateDashboard(); } }
function usePrompt(prompt) { document.getElementById('promptInput').value = prompt; generateDashboard(); }

function createNewDashboard() {
    currentDashboardId = null;
    currentWidgets = [];
    currentFilters = [];
    filterValues = {};
    Object.values(chartInstances).forEach(c => c.destroy());
    chartInstances = {};
    document.getElementById('dashboardTitle').textContent = 'New Dashboard';
    document.getElementById('dashboardGrid').innerHTML = '';
    document.getElementById('dashboardGrid').style.display = 'none';
    document.getElementById('emptyState').style.display = 'flex';
    document.getElementById('promptInput').value = '';
    document.getElementById('filtersBar').classList.remove('show');
    renderFilters();
    document.querySelectorAll('.dashboard-item').forEach(i => i.classList.remove('active'));
}

function toggleFilters() { document.getElementById('filtersBar').classList.toggle('show'); }

async function loadColumns() {
    availableColumns = [];
    console.log('Loading columns for tables:', MODULE_TABLES);
    
    for (const table of MODULE_TABLES) {
        const tableName = typeof table === 'string' ? table : (table.name || table.table_name || '');
        if (!tableName) continue;
        
        try {
            console.log('Fetching columns for:', tableName);
            const r = await fetch(`/api/table-columns/?table=${encodeURIComponent(tableName)}`);
            const d = await r.json();
            console.log('Columns for', tableName, ':', d);
            
            if (d.columns && d.columns.length > 0) {
                d.columns.forEach(c => {
                    availableColumns.push({ 
                        table: tableName, 
                        name: typeof c === 'string' ? c : c.name, 
                        type: typeof c === 'string' ? 'unknown' : (c.type || 'unknown')
                    });
                });
            }
        } catch(e) { 
            console.error('Error loading columns for', tableName, e); 
        }
    }
    
    console.log('Total columns loaded:', availableColumns.length);
    return availableColumns;
}

function openFilterModal() {
    const modal = document.getElementById('filterModal');
    const list = document.getElementById('columnList');
    list.innerHTML = '<div style="padding:20px;text-align:center;color:#909296;">Loading columns...</div>';
    modal.classList.add('show');
    selectedFilterColumns = new Set(currentFilters.map(f => `${f.table}.${f.column}`));
    
    loadColumns().then(() => {
        console.log('Columns loaded, count:', availableColumns.length);
        
        if (!availableColumns.length) { 
            list.innerHTML = '<div style="padding:20px;color:#909296;text-align:center;">No columns found.<br><small>Check if tables are configured in module.</small></div>'; 
            return; 
        }
        
        const byTable = {};
        availableColumns.forEach(c => { 
            if (!byTable[c.table]) byTable[c.table] = []; 
            byTable[c.table].push(c); 
        });
        
        let html = '';
        for (const [table, cols] of Object.entries(byTable)) {
            html += `<div style="margin-bottom:16px;">
                <div style="font-size:12px;font-weight:600;color:#667eea;margin-bottom:8px;padding:4px 8px;background:#667eea20;border-radius:4px;">${table} (${cols.length} columns)</div>`;
            
            cols.forEach(c => {
                const key = `${c.table}.${c.name}`;
                const sel = selectedFilterColumns.has(key);
                html += `<div class="column-item ${sel?'selected':''}" data-key="${key}" onclick="toggleFilterColumn('${key}')">
                    <input type="checkbox" ${sel?'checked':''} onclick="event.stopPropagation()">
                    <div class="column-info">
                        <div class="column-name">${c.name}</div>
                        <div class="column-table">${c.type}</div>
                    </div>
                </div>`;
            });
            html += '</div>';
        }
        list.innerHTML = html;
    }).catch(err => {
        console.error('Error in loadColumns:', err);
        list.innerHTML = '<div style="padding:20px;color:#ef4444;text-align:center;">Error loading columns<br><small>' + err.message + '</small></div>';
    });
}

function toggleFilterColumn(key) {
    if (selectedFilterColumns.has(key)) selectedFilterColumns.delete(key);
    else selectedFilterColumns.add(key);
    const el = document.querySelector(`.column-item[data-key="${key}"]`);
    if (el) { el.classList.toggle('selected'); el.querySelector('input').checked = selectedFilterColumns.has(key); }
}

function closeFilterModal() { document.getElementById('filterModal').classList.remove('show'); }

async function applySelectedFilters() {
    currentFilters = [];
    for (const key of selectedFilterColumns) {
        const [table, column] = key.split('.');
        currentFilters.push({ table, column, values: [] });
    }
    
    for (const f of currentFilters) {
        try {
            const r = await fetch('/dashboard/api/filter-values/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ table: f.table, column: f.column })
            });
            const d = await r.json();
            f.values = d.values || [];
        } catch(e) { console.error(e); }
    }
    
    closeFilterModal();
    renderFilters();
    if (currentFilters.length) document.getElementById('filtersBar').classList.add('show');
}

function renderFilters() {
    const c = document.getElementById('filtersContainer');
    if (!currentFilters.length) { c.innerHTML = '<div style="color:#909296;font-size:13px;padding:8px;">No filters. Click "Add Filter" to create slicers.</div>'; return; }
    
    c.innerHTML = currentFilters.map((f, i) => `
        <div class="filter-chip">
            <div>
                <div class="filter-label">${f.column}</div>
                <select onchange="onFilterChange(${i}, this.value)">
                    <option value="">All</option>
                    ${f.values.map(v => `<option value="${escapeHtml(String(v))}" ${filterValues[`${f.table}.${f.column}`]===String(v)?'selected':''}>${escapeHtml(String(v))}</option>`).join('')}
                </select>
            </div>
            <button class="remove-filter" onclick="removeFilter(${i})">√ó</button>
        </div>
    `).join('');
}

function onFilterChange(i, val) {
    const f = currentFilters[i];
    const k = `${f.table}.${f.column}`;
    if (val) filterValues[k] = val; else delete filterValues[k];
    if (currentWidgets.length) refreshDashboard();
}

function removeFilter(i) {
    const f = currentFilters[i];
    delete filterValues[`${f.table}.${f.column}`];
    currentFilters.splice(i, 1);
    renderFilters();
}

async function generateDashboard() {
    const prompt = document.getElementById('promptInput').value.trim();
    if (!prompt || isGenerating) return;
    
    isGenerating = true;
    document.getElementById('sendBtn').disabled = true;
    Object.values(chartInstances).forEach(c => c.destroy());
    chartInstances = {};
    
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('dashboardGrid').style.display = 'grid';
    document.getElementById('dashboardGrid').innerHTML = `<div style="grid-column:1/-1;display:flex;align-items:center;justify-content:center;min-height:300px;"><div style="text-align:center;"><div class="loading-spinner" style="margin:0 auto 16px;"></div><div style="color:#909296;">Generating dashboard...</div></div></div>`;
    
    try {
        const r = await fetch('/dashboard/api/generate/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ prompt, module_id: MODULE_ID, filters: filterValues })
        });
        const data = await r.json();
        
        if (data.success) {
            currentWidgets = data.widgets || [];
            renderDashboard(data);
            if (data.title) document.getElementById('dashboardTitle').textContent = data.title;
        } else throw new Error(data.error || 'Failed');
    } catch(e) {
        console.error(e);
        document.getElementById('dashboardGrid').innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:#ef4444;"><div style="font-size:48px;margin-bottom:16px;">‚ùå</div><div>${e.message}</div></div>`;
    } finally {
        isGenerating = false;
        document.getElementById('sendBtn').disabled = false;
    }
}

function renderDashboard(data) {
    const grid = document.getElementById('dashboardGrid');
    grid.innerHTML = '';
    Object.values(chartInstances).forEach(c => c.destroy());
    chartInstances = {};
    
    if (!data.widgets?.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#909296;">No widgets</div>'; return; }
    
    data.widgets.forEach((w, i) => grid.appendChild(createWidget(w, i)));
    setTimeout(() => data.widgets.forEach((w, i) => { if (w.type === 'chart') initChart(w, i); }), 100);
}

function createWidget(w, i) {
    const div = document.createElement('div');
    div.className = 'widget-card';
    div.id = `widget-${i}`;
    if (w.type === 'kpi' || w.fullWidth) div.style.gridColumn = '1/-1';
    
    let content = '';
    if (w.type === 'kpi') content = renderKPI(w);
    else if (w.type === 'chart') content = `<div class="chart-container"><canvas id="chart-${i}"></canvas></div>`;
    else if (w.type === 'table') content = renderTable(w);
    else content = '<div style="color:#909296;">Unknown type</div>';
    
    div.innerHTML = `<div class="widget-header"><div class="widget-title">${escapeHtml(w.title||'Widget')}</div><div class="widget-actions"><button class="widget-btn" onclick="removeWidget(${i})">‚úï</button></div></div><div class="widget-content">${content}</div>`;
    return div;
}

function renderKPI(w) {
    if (!w.kpis?.length) return '<div style="color:#909296;">No KPIs</div>';
    return '<div class="kpi-grid">' + w.kpis.map(k => `<div class="kpi-card"><div class="kpi-value">${formatVal(k.value, k.format)}</div><div class="kpi-label">${escapeHtml(k.label)}</div>${k.change!=null?`<div class="kpi-change ${k.change>0?'positive':k.change<0?'negative':''}">${k.change>0?'‚Üë':k.change<0?'‚Üì':''} ${Math.abs(k.change)}%</div>`:''}</div>`).join('') + '</div>';
}

function renderTable(w) {
    if (!w.data?.length) return '<div style="color:#909296;">No data</div>';
    const cols = w.columns || Object.keys(w.data[0]);
    return `<div class="data-table-container"><table class="data-table"><thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr></thead><tbody>${w.data.slice(0,20).map(r=>'<tr>'+cols.map(c=>`<td>${escapeHtml(String(r[c]??'-'))}</td>`).join('')+'</tr>').join('')}</tbody></table></div>${w.data.length>20?`<div style="padding:8px;text-align:center;color:#909296;font-size:12px;">Showing 20 of ${w.data.length}</div>`:''}`;
}

function initChart(w, i) {
    const ctx = document.getElementById(`chart-${i}`);
    if (!ctx) return;
    chartInstances[i] = new Chart(ctx, {
        type: w.chartType || 'bar',
        data: {
            labels: w.labels || [],
            datasets: [{ label: w.title||'Data', data: w.values||[], backgroundColor: ['#667eea','#764ba2','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16','#f97316','#ec4899'], borderColor: w.chartType==='line'?'#667eea':undefined, borderWidth: w.chartType==='line'?2:0, tension:0.3 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: w.chartType==='pie'||w.chartType==='doughnut', position:'bottom', labels:{color:'#909296'} } },
            scales: w.chartType!=='pie'&&w.chartType!=='doughnut' ? { x:{grid:{color:'#373a40'},ticks:{color:'#909296'}}, y:{grid:{color:'#373a40'},ticks:{color:'#909296'}} } : undefined
        }
    });
}

function formatVal(v, f) { if (v==null) return '-'; if (f==='currency') return '‚Çπ'+Number(v).toLocaleString('en-IN'); if (f==='percentage') return v+'%'; return Number(v).toLocaleString('en-IN'); }
function removeWidget(i) { const w=document.getElementById(`widget-${i}`); if(w){if(chartInstances[i]){chartInstances[i].destroy();delete chartInstances[i];}w.remove();currentWidgets.splice(i,1);} }
function refreshDashboard() { if(document.getElementById('promptInput').value.trim()) generateDashboard(); }

async function saveDashboard() {
    if (!currentWidgets?.length) { alert('Generate a dashboard first!'); return; }
    const title = prompt('Dashboard name:', document.getElementById('dashboardTitle').textContent==='New Dashboard'?'My Dashboard':document.getElementById('dashboardTitle').textContent);
    if (!title) return;
    
    try {
        const r = await fetch('/dashboard/api/save/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ dashboard_id: currentDashboardId, module_id: MODULE_ID, title, widgets: currentWidgets, filters: currentFilters, prompt: document.getElementById('promptInput').value })
        });
        const d = await r.json();
        if (d.success) {
            currentDashboardId = d.dashboard_id;
            document.getElementById('dashboardTitle').textContent = title;
            await loadDashboardsList();
            alert('Saved!');
        } else throw new Error(d.error);
    } catch(e) { alert('Save failed: '+e.message); }
}

function exportDashboard() {
    const blob = new Blob([JSON.stringify({title:document.getElementById('dashboardTitle').textContent,widgets:currentWidgets,filters:currentFilters},null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`dashboard-${Date.now()}.json`; a.click();
}

async function loadDashboardsList() {
    const list = document.getElementById('dashboardsList');
    try {
        const r = await fetch(`/dashboard/api/list/?module_id=${MODULE_ID}`);
        const d = await r.json();
        if (!d.dashboards?.length) { list.innerHTML = '<div style="padding:20px;text-align:center;color:#909296;font-size:13px">No dashboards yet</div>'; return; }
        list.innerHTML = d.dashboards.map(db => `<div class="dashboard-item ${db.id===currentDashboardId?'active':''}" onclick="loadDashboard(${db.id})"><div class="dashboard-item-title">${escapeHtml(db.title)}</div><div class="dashboard-item-meta">${db.widget_count||0} widgets</div><button class="delete-dashboard-btn" onclick="event.stopPropagation();deleteDashboard(${db.id})">üóëÔ∏è</button></div>`).join('');
    } catch(e) { list.innerHTML = '<div style="padding:20px;color:#ef4444;">Error loading</div>'; }
}

async function loadDashboard(id) {
    try {
        const r = await fetch(`/dashboard/api/get/${id}/`);
        const d = await r.json();
        if (d.success) {
            currentDashboardId = id;
            currentWidgets = d.widgets || [];
            currentFilters = d.filters || [];
            document.getElementById('dashboardTitle').textContent = d.title;
            document.getElementById('promptInput').value = d.prompt || '';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('dashboardGrid').style.display = 'grid';
            renderFilters();
            if (currentFilters.length) document.getElementById('filtersBar').classList.add('show');
            renderDashboard(d);
            document.querySelectorAll('.dashboard-item').forEach(i=>i.classList.remove('active'));
            document.querySelector(`.dashboard-item[onclick="loadDashboard(${id})"]`)?.classList.add('active');
        }
    } catch(e) { alert('Load failed'); }
}

async function deleteDashboard(id) {
    if (!confirm('Delete?')) return;
    try {
        await fetch(`/dashboard/api/delete/${id}/`,{method:'DELETE',headers:{'X-CSRFToken':getCookie('csrftoken')}});
        if (id===currentDashboardId) createNewDashboard();
        loadDashboardsList();
    } catch(e) {}
}

function escapeHtml(t) { const d=document.createElement('div'); d.textContent=String(t??''); return d.innerHTML; }
function getCookie(n) { let v=null; document.cookie.split(';').forEach(c=>{const t=c.trim();if(t.startsWith(n+'='))v=decodeURIComponent(t.substring(n.length+1));}); return v; }

document.addEventListener('DOMContentLoaded', () => loadDashboardsList());
</script>
</body>
</html>