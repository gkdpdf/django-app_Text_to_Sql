{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Create New Module</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#2b2b31;--panel:#222227;--muted:#9aa0ab;--card:#26282d;--accent:#19c37d;--accent-2:#667eea;--border:#3a3a40;--text:#e6e6ea;--surface:#2f3136}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .panel{background:var(--surface);padding:16px;border-radius:10px;border:1px solid var(--border);margin-bottom:14px}
    .table-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
    .table-item{background:var(--card);padding:10px;border-radius:8px;border:1px solid #2f3136}
    .table-header{display:flex;align-items:center;gap:12px}
    .columns-container{display:none;margin-top:8px;max-height:240px;overflow:auto;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px}
    .column-item{padding:6px 8px;display:flex;align-items:center;gap:8px}
    .column-item:hover{background:rgba(255,255,255,0.05);border-radius:4px}
    .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s}
    .btn-primary{background:linear-gradient(135deg,var(--accent-2),#4f46e5);color:#fff}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(102,126,234,0.4)}
    .btn-success{background:linear-gradient(135deg,var(--accent),#0ea36e);color:#fff}
    .btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
    .muted{color:var(--muted)}
    .small{font-size:0.85em}
    input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:var(--card);color:var(--text)}
    input[type="text"]:focus{outline:none;border-color:var(--accent-2)}
    .error-msg{background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.5);padding:12px;border-radius:8px;margin-bottom:16px;color:#fca5a5}
    .selection-info{background:rgba(25,195,125,0.1);border:1px solid rgba(25,195,125,0.3);padding:10px 14px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
    .expand-icon{cursor:pointer;color:var(--muted);font-size:14px;padding:4px 8px;transition:transform 0.2s}
    .expand-icon.expanded{transform:rotate(90deg)}
  </style>
</head>
<body>
  <div class="container">
    <h2 style="margin-bottom:8px">Create New Module</h2>
    <p class="muted" style="margin-bottom:20px">Select tables and columns to include in your module's knowledge graph.</p>
    
    {% if error %}
    <div class="error-msg">⚠️ {{ error }}</div>
    {% endif %}
    
    <form id="newModuleForm" method="POST" novalidate>
      {% csrf_token %}
      <input type="hidden" id="selectedColumnsInput" name="selected_columns" value="{}">
      
      <div class="panel">
        <label class="muted small" style="display:block;margin-bottom:6px">Module Name *</label>
        <input id="module_name" name="module_name" type="text" placeholder="Enter module name" required>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <strong>Select Tables & Columns</strong>
            <p class="muted small" style="margin:4px 0 0 0">Check a table to select it. Click the arrow to expand and select specific columns.</p>
          </div>
          <div style="display:flex;gap:8px">
            <button type="button" class="btn btn-success" id="selectAllTablesBtn">Select All</button>
            <button type="button" class="btn btn-secondary" id="deselectAllTablesBtn">Deselect All</button>
          </div>
        </div>
        
        <div id="selectionInfo" class="selection-info" style="display:none">
          <span id="selectionSummary">0 tables, 0 columns selected</span>
        </div>

        <div class="table-list" id="tableList">
          {% for table in tables %}
          <div class="table-item" data-table="{{ table }}">
            <div class="table-header">
              <input type="checkbox" name="selected_tables" value="{{ table }}" id="tblchk_{{ table }}" onclick="event.stopPropagation();" onchange="onTableCheckboxChange(this,'{{ table }}')">
              <div style="flex:1;cursor:pointer;font-weight:500" onclick="onTableNameClick('{{ table }}', event)">{{ table }}</div>
              <div class="expand-icon" id="expand_{{ table }}" onclick="toggleTableExpand('{{ table }}'); event.stopPropagation()">▶</div>
            </div>
            <div class="columns-container" id="columns_{{ table }}">
              <div class="muted small">Loading columns...</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <a class="btn btn-secondary" href="{% url 'dashboard' %}">Cancel</a>
        <button type="button" class="btn btn-primary" onclick="onCreateSubmit(event)">Create Module →</button>
      </div>
    </form>
  </div>

  <script>
    // State management
    let selectedColumns = {};
    let loadedTables = new Set();
    let tableColumnsCache = {};

    // Sync hidden input with current selection state
    function syncHiddenInput() {
      const input = document.getElementById('selectedColumnsInput');
      if (input) {
        input.value = JSON.stringify(selectedColumns);
      }
      updateSelectionSummary();
    }

    // Update selection summary display
    function updateSelectionSummary() {
      const tableCount = Object.keys(selectedColumns).length;
      let columnCount = 0;
      for (const cols of Object.values(selectedColumns)) {
        columnCount += cols.length;
      }
      
      const infoEl = document.getElementById('selectionInfo');
      const summaryEl = document.getElementById('selectionSummary');
      
      if (tableCount > 0) {
        infoEl.style.display = 'flex';
        summaryEl.textContent = `${tableCount} table${tableCount !== 1 ? 's' : ''}, ${columnCount} column${columnCount !== 1 ? 's' : ''} selected`;
      } else {
        infoEl.style.display = 'none';
      }
    }

    // Load columns for a table from server
    async function loadTableColumns(tableName) {
      const container = document.getElementById('columns_' + tableName);
      if (!container) return;

      // Check cache first
      if (tableColumnsCache[tableName]) {
        renderColumns(tableName, tableColumnsCache[tableName]);
        return;
      }

      container.innerHTML = '<div class="muted small">⏳ Loading columns...</div>';

      try {
        const resp = await fetch(`/get-table-columns/?table=${encodeURIComponent(tableName)}`);
        const data = await resp.json();

        if (!data.columns || data.columns.length === 0) {
          container.innerHTML = '<div class="muted small">No columns found</div>';
          return;
        }

        // Cache the columns
        tableColumnsCache[tableName] = data.columns;
        renderColumns(tableName, data.columns);
        loadedTables.add(tableName);

      } catch (e) {
        console.error('Error loading columns for', tableName, e);
        container.innerHTML = '<div class="muted small" style="color:#fca5a5">Error loading columns</div>';
      }
    }

    // Render column checkboxes
    function renderColumns(tableName, columns) {
      const container = document.getElementById('columns_' + tableName);
      if (!container) return;

      const currentSelection = selectedColumns[tableName] || [];
      
      let html = `
        <div style="display:flex;gap:8px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">
          <button type="button" class="btn btn-success small" style="padding:4px 8px;font-size:12px" onclick="selectAllColumnsForTable('${tableName}')">All</button>
          <button type="button" class="btn btn-secondary small" style="padding:4px 8px;font-size:12px" onclick="deselectAllColumnsForTable('${tableName}')">None</button>
        </div>
      `;

      for (const col of columns) {
        const colName = col.name;
        const colType = col.type || '';
        const safeId = `col_${tableName}_${colName}`.replace(/[^a-zA-Z0-9_]/g, '_');
        const checked = currentSelection.includes(colName) ? 'checked' : '';
        
        html += `
          <div class="column-item">
            <input type="checkbox" id="${safeId}" value="${colName}" ${checked} 
                   onchange="toggleColumn('${tableName}', '${colName}', this.checked)">
            <label for="${safeId}" style="flex:1;cursor:pointer">${colName}</label>
            <span class="muted small">${colType}</span>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    // Toggle expand/collapse for table columns
    function toggleTableExpand(tableName) {
      const container = document.getElementById('columns_' + tableName);
      const icon = document.getElementById('expand_' + tableName);
      if (!container) return;

      const isExpanded = container.style.display === 'block';

      if (isExpanded) {
        container.style.display = 'none';
        if (icon) {
          icon.textContent = '▶';
          icon.classList.remove('expanded');
        }
      } else {
        // Load columns if not already loaded
        if (!loadedTables.has(tableName)) {
          loadTableColumns(tableName).then(() => {
            container.style.display = 'block';
            if (icon) {
              icon.textContent = '▼';
              icon.classList.add('expanded');
            }
          });
        } else {
          container.style.display = 'block';
          if (icon) {
            icon.textContent = '▼';
            icon.classList.add('expanded');
          }
        }
      }
    }

    // Handle click on table name (expand + check if not checked)
    function onTableNameClick(tableName, event) {
      event.stopPropagation();
      
      const checkbox = document.querySelector(`input[name="selected_tables"][value="${tableName}"]`);
      
      // If not checked, check it and select all columns
      if (checkbox && !checkbox.checked) {
        checkbox.checked = true;
        loadTableColumns(tableName).then(() => {
          selectAllColumnsForTable(tableName);
          toggleTableExpand(tableName);
        });
      } else {
        toggleTableExpand(tableName);
      }
    }

    // Handle table checkbox change
    function onTableCheckboxChange(checkbox, tableName) {
      if (checkbox.checked) {
        // Load and select all columns
        loadTableColumns(tableName).then(() => {
          selectAllColumnsForTable(tableName);
        });
      } else {
        // Deselect all columns
        deselectAllColumnsForTable(tableName);
      }
    }

    // Select all columns for a table
    function selectAllColumnsForTable(tableName) {
      const container = document.getElementById('columns_' + tableName);
      
      if (!container || !loadedTables.has(tableName)) {
        // Need to load first
        loadTableColumns(tableName).then(() => {
          selectAllColumnsForTable(tableName);
        });
        return;
      }

      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      const cols = [];
      
      checkboxes.forEach(cb => {
        cb.checked = true;
        cols.push(cb.value);
      });

      if (cols.length > 0) {
        selectedColumns[tableName] = [...new Set(cols)];
      }

      // Ensure table checkbox is checked
      const tableCheckbox = document.querySelector(`input[name="selected_tables"][value="${tableName}"]`);
      if (tableCheckbox) tableCheckbox.checked = true;

      syncHiddenInput();
    }

    // Deselect all columns for a table
    function deselectAllColumnsForTable(tableName) {
      const container = document.getElementById('columns_' + tableName);
      
      if (container) {
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
        });
      }

      delete selectedColumns[tableName];

      // Uncheck table checkbox
      const tableCheckbox = document.querySelector(`input[name="selected_tables"][value="${tableName}"]`);
      if (tableCheckbox) tableCheckbox.checked = false;

      syncHiddenInput();
    }

    // Toggle individual column selection
    function toggleColumn(tableName, columnName, isChecked) {
      if (!selectedColumns[tableName]) {
        selectedColumns[tableName] = [];
      }

      if (isChecked) {
        if (!selectedColumns[tableName].includes(columnName)) {
          selectedColumns[tableName].push(columnName);
        }
      } else {
        selectedColumns[tableName] = selectedColumns[tableName].filter(c => c !== columnName);
        if (selectedColumns[tableName].length === 0) {
          delete selectedColumns[tableName];
        }
      }

      // Update table checkbox state
      const container = document.getElementById('columns_' + tableName);
      const checkedCount = container ? container.querySelectorAll('input[type="checkbox"]:checked').length : 0;
      const tableCheckbox = document.querySelector(`input[name="selected_tables"][value="${tableName}"]`);
      
      if (tableCheckbox) {
        tableCheckbox.checked = checkedCount > 0;
      }

      syncHiddenInput();
    }

    // Select All Tables button handler
    document.getElementById('selectAllTablesBtn').addEventListener('click', async function() {
      const allCheckboxes = document.querySelectorAll('input[name="selected_tables"]');
      
      for (const cb of allCheckboxes) {
        if (!cb.checked) {
          cb.checked = true;
          await loadTableColumns(cb.value);
          selectAllColumnsForTable(cb.value);
        } else {
          selectAllColumnsForTable(cb.value);
        }
      }
    });

    // Deselect All Tables button handler
    document.getElementById('deselectAllTablesBtn').addEventListener('click', function() {
      document.querySelectorAll('input[name="selected_tables"]').forEach(cb => {
        if (cb.checked) {
          cb.checked = false;
          deselectAllColumnsForTable(cb.value);
        }
      });
    });

    // Form submission handler
    function onCreateSubmit(event) {
      event.preventDefault();
      
      const name = document.getElementById('module_name').value.trim();
      if (!name) {
        alert('Please enter a module name');
        document.getElementById('module_name').focus();
        return;
      }

      const selectedTables = Array.from(
        document.querySelectorAll('input[name="selected_tables"]:checked')
      ).map(cb => cb.value);

      if (selectedTables.length === 0) {
        alert('Please select at least one table');
        return;
      }

      // Ensure selectedColumns only contains checked tables
      const finalColumns = {};
      for (const table of selectedTables) {
        if (selectedColumns[table] && selectedColumns[table].length > 0) {
          finalColumns[table] = selectedColumns[table];
        }
      }
      selectedColumns = finalColumns;

      // Sync and submit
      syncHiddenInput();
      
      // Debug log
      console.log('Submitting:', {
        name: name,
        tables: selectedTables,
        columns: selectedColumns
      });

      document.getElementById('newModuleForm').submit();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateSelectionSummary();
    });
  </script>
</body>
</html>