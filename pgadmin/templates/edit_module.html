{% load dict_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Edit Module: {{ module.name }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#2b2b31;--panel:#222227;--muted:#9aa0ab;--card:#26282d;--accent:#19c37d;--accent-2:#667eea;--border:#3a3a40;--text:#e6e6ea;--surface:#2f3136;--warning:#f59e0b;--ai:#8b5cf6}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:18px;padding-bottom:120px}
    .panel{background:var(--surface);border-radius:10px;padding:0;margin-bottom:14px;border:1px solid var(--border)}
    .panel-header{display:flex;align-items:center;padding:12px 16px;cursor:pointer;transition:background 0.2s}
    .panel-header:hover{background:rgba(255,255,255,0.03)}
    .panel-title{font-weight:700}
    .panel-body{padding:16px;display:none;border-top:1px solid var(--border)}
    .table-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
    .table-item{background:var(--card);padding:10px;border-radius:8px;border:1px solid #2f3136;transition:border-color 0.2s}
    .table-item:hover{border-color:var(--accent-2)}
    .table-item.selected{border-color:var(--accent)}
    .table-header{display:flex;align-items:center;gap:10px}
    .columns-container{display:none;margin-top:8px;max-height:300px;overflow:auto;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px}
    .column-item{padding:6px 8px;display:flex;align-items:center;gap:8px}
    .column-item:hover{background:rgba(255,255,255,0.05);border-radius:4px}
    .kg-table{width:100%;border-collapse:collapse;margin-top:8px}
    .kg-table th,.kg-table td{padding:10px;text-align:left;border-bottom:1px solid var(--border)}
    .kg-table th{color:var(--muted);font-weight:500;font-size:0.9em}
    textarea,input[type="text"]{width:100%;padding:8px;border-radius:6px;background:var(--card);border:1px solid #2f3136;color:var(--text);transition:border-color 0.2s}
    textarea:focus,input[type="text"]:focus{outline:none;border-color:var(--accent-2)}
    .muted{color:var(--muted)}
    .small{font-size:0.85em}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s}
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
    .btn-primary{background:linear-gradient(135deg,var(--accent-2),#4f46e5);color:white}
    .btn-success{background:linear-gradient(135deg,var(--accent),#0ea36e);color:white}
    .btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:white}
    .btn-ai{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:10px 16px}
    .btn-ai:hover{box-shadow:0 4px 15px rgba(139,92,246,0.4)}
    .sticky-bar{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg, rgba(43,43,49,0.95), rgba(34,34,39,0.98));padding:14px;border-top:1px solid var(--border);backdrop-filter:blur(10px)}
    .sticky-inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .selection-badge{background:var(--accent);color:white;padding:4px 10px;border-radius:12px;font-size:0.85em;font-weight:600}
    .kg-section{margin-bottom:16px;background:var(--card);border-radius:8px;overflow:hidden}
    .kg-section-header{padding:12px 16px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.2)}
    .kg-section-header:hover{background:rgba(0,0,0,0.3)}
    .kg-section-body{display:none;padding:16px}
    .expand-icon{color:var(--muted);transition:transform 0.2s}
    .expand-icon.expanded{transform:rotate(90deg)}
    .info-box{background:rgba(102,126,234,0.1);border:1px solid rgba(102,126,234,0.3);padding:12px;border-radius:8px;margin-bottom:12px}
    .ai-info-box{background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);padding:12px;border-radius:8px;margin-bottom:12px}
    .dynamic-item{background:var(--card);padding:12px;border-radius:8px;margin-bottom:8px;border:1px solid var(--border)}
    .rel-select{width:100%;padding:8px;border-radius:6px;background:var(--card);border:1px solid #2f3136;color:var(--text);margin-top:4px}
    .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;display:none}
    .loading-content{background:var(--surface);padding:30px 40px;border-radius:12px;text-align:center}
    .loading-spinner{width:50px;height:50px;border:4px solid var(--border);border-top-color:var(--ai);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .checkbox-group{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(139,92,246,0.1);border-radius:8px;margin-right:auto}
    .checkbox-group input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
    .checkbox-group label{cursor:pointer;font-weight:500}
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div style="font-weight:600;font-size:1.1em;margin-bottom:8px">ü§ñ AI is generating descriptions...</div>
      <div class="muted">This may take a moment depending on the number of tables/columns</div>
    </div>
  </div>

  <h1 style="margin-bottom:4px">Edit Module ‚Äî {{ module.name }}</h1>
  <p class="muted" style="margin-bottom:20px">Manage tables, columns and the knowledge graph.</p>

  <form id="mainForm" method="POST">
    {% csrf_token %}
    <input type="hidden" name="action" value="save_all">
    <input type="hidden" name="run_ai" id="runAiInput" value="false">
    <input type="hidden" name="selected_columns" id="selectedColumnsInput" value='{{ selected_columns_json|safe }}'>

    <!-- TABLE & COLUMN SELECTION PANEL -->
    <div class="panel">
      <div class="panel-header" onclick="toggleSection('tablePanel')">
        <span class="expand-icon" id="tablePanel-icon">‚ñ∂</span>
        <span style="margin-left:8px" class="panel-title">üìã Table & Column Selection</span>
        <span style="margin-left:auto" class="muted small">Select tables & columns to include</span>
      </div>
      <div id="tablePanel-body" class="panel-body">
        <div class="info-box">
          <strong>How it works:</strong> Check tables to include them. Expand to select specific columns. 
          The Knowledge Graph below will automatically update to show only selected tables/columns.
        </div>
        
        <div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap">
          <button type="button" class="btn btn-success" id="selectAllTablesBtn">Select All Tables</button>
          <button type="button" class="btn btn-secondary" id="deselectAllTablesBtn">Deselect All</button>
          <div style="margin-left:auto" id="selectionSummary" class="muted"></div>
        </div>

        <div class="table-list">
          {% for table in tables %}
          <div class="table-item {% if table in selected_tables %}selected{% endif %}" data-table="{{ table }}">
            <div class="table-header">
              <input type="checkbox" name="selected_tables" value="{{ table }}" 
                     {% if table in selected_tables %}checked{% endif %} 
                     onchange="onTableCheckboxChange(this,'{{ table }}')" 
                     onclick="event.stopPropagation()">
              <div style="flex:1;cursor:pointer;font-weight:500" onclick="onTableNameClick('{{ table }}', event)">{{ table }}</div>
              <span class="expand-icon" id="expand_{{ table }}" onclick="toggleTableExpand('{{ table }}'); event.stopPropagation()">‚ñ∂</span>
            </div>
            <div class="columns-container" id="columns_{{ table }}">
              <div class="muted small">Loading columns...</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- KNOWLEDGE GRAPH PANEL -->
    <div class="panel">
      <div class="panel-header" onclick="toggleSection('kgPanel')">
        <span class="expand-icon" id="kgPanel-icon">‚ñ∂</span>
        <span style="margin-left:8px" class="panel-title">üß† Knowledge Graph</span>
        <span style="margin-left:auto" class="muted small">Edit descriptions & datatypes for selected columns</span>
      </div>
      <div id="kgPanel-body" class="panel-body">
        <div class="ai-info-box">
          <strong>ü§ñ AI Auto-Fill:</strong> Check the "Run AI to fill blank descriptions" option at the bottom and click Save. 
          AI will automatically generate descriptions for any empty table or column description fields.
        </div>
        
        <div id="kgContainer">
          {% if knowledge_data %}
            {% for table, cols in knowledge_data.items %}
            <div class="kg-section" data-kg-table="{{ table }}">
              <div class="kg-section-header" onclick="toggleKGTable('{{ table }}')">
                <div>
                  <strong style="color:var(--text)">{{ table }}</strong>
                  <span class="muted small" style="margin-left:8px">({{ cols|length }} columns)</span>
                </div>
                <span class="expand-icon" id="kg_icon_{{ table }}">‚ñ∂</span>
              </div>
              <div id="kg_wrapper_{{ table }}" class="kg-section-body">
                <div style="margin-bottom:12px">
                  <label class="muted small">Table Description</label>
                  <textarea name="table_info__{{ table }}" rows="2" placeholder="Describe what this table contains... (AI will fill if empty)">{{ table_info_map|get_item:table }}</textarea>
                </div>
                <table class="kg-table">
                  <thead>
                    <tr>
                      <th style="width:25%">Column</th>
                      <th style="width:50%">Description</th>
                      <th style="width:25%">Datatype</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for col_name, info in cols.items %}
                    <tr data-column="{{ col_name }}">
                      <td style="font-weight:600">{{ col_name }}</td>
                      <td><textarea name="kg_desc__{{ table }}__{{ col_name }}" rows="2" placeholder="Describe this column... (AI will fill if empty)">{{ info.desc }}</textarea></td>
                      <td><input type="text" name="kg_datatype__{{ table }}__{{ col_name }}" value="{{ info.datatype }}" placeholder="e.g., varchar, int"></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="muted" style="padding:20px;text-align:center">
              No tables selected yet. Select tables above and save to see the knowledge graph.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- RELATIONSHIPS PANEL -->
    <div class="panel">
      <div class="panel-header" onclick="toggleSection('relPanel')">
        <span class="expand-icon" id="relPanel-icon">‚ñ∂</span>
        <span style="margin-left:8px" class="panel-title">üîó Table Relationships / Joins</span>
        <span style="margin-left:auto" class="muted small">Define how tables connect</span>
      </div>
      <div id="relPanel-body" class="panel-body">
        <div id="relationshipsList">
          {% for rel in relationships %}
          <div class="dynamic-item relationship-item">
            <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:start">
              <div>
                <label class="muted small">Left Table</label>
                <select name="rel_left_table" class="rel-select" onchange="loadColumnsForRelationship(this,'left')">
                  <option value="">Select table...</option>
                  {% for t in selected_tables %}
                    <option value="{{ t }}" {% if rel.left_table == t %}selected{% endif %}>{{ t }}</option>
                  {% endfor %}
                </select>
                <label class="muted small" style="margin-top:8px;display:block">Column</label>
                <select name="rel_left_column" class="rel-select rel-column-select" data-value="{{ rel.left_column }}">
                  <option value="">Select column...</option>
                </select>
              </div>
              <div style="text-align:center;padding-top:20px">
                <label class="muted small">Type</label>
                <select name="rel_type" class="rel-select" style="width:100px">
                  <option value="one-to-one" {% if rel.type == 'one-to-one' %}selected{% endif %}>1:1</option>
                  <option value="one-to-many" {% if rel.type == 'one-to-many' %}selected{% endif %}>1:N</option>
                  <option value="many-to-one" {% if rel.type == 'many-to-one' %}selected{% endif %}>N:1</option>
                  <option value="many-to-many" {% if rel.type == 'many-to-many' %}selected{% endif %}>N:N</option>
                </select>
              </div>
              <div>
                <label class="muted small">Right Table</label>
                <select name="rel_right_table" class="rel-select" onchange="loadColumnsForRelationship(this,'right')">
                  <option value="">Select table...</option>
                  {% for t in selected_tables %}
                    <option value="{{ t }}" {% if rel.right_table == t %}selected{% endif %}>{{ t }}</option>
                  {% endfor %}
                </select>
                <label class="muted small" style="margin-top:8px;display:block">Column</label>
                <select name="rel_right_column" class="rel-select rel-column-select" data-value="{{ rel.right_column }}">
                  <option value="">Select column...</option>
                </select>
              </div>
            </div>
            <div style="margin-top:10px;text-align:right">
              <button type="button" class="btn btn-danger small" onclick="this.closest('.relationship-item').remove()">Remove</button>
            </div>
          </div>
          {% endfor %}
        </div>
        <button type="button" class="btn btn-success" onclick="addRelationship()" style="margin-top:8px">+ Add Relationship</button>
      </div>
    </div>

    <!-- RCA PANEL -->
    <div class="panel">
      <div class="panel-header" onclick="toggleSection('rcaPanel')">
        <span class="expand-icon" id="rcaPanel-icon">‚ñ∂</span>
        <span style="margin-left:8px" class="panel-title">üìå Root Cause Analysis (RCA)</span>
      </div>
      <div id="rcaPanel-body" class="panel-body">
        <div id="rcaList">
          {% for r in rca_list %}
          <div class="dynamic-item">
            <input type="text" name="rca_title" value="{{ r.title }}" placeholder="RCA Title" style="margin-bottom:8px">
            <textarea name="rca_content" placeholder="RCA Content" rows="3">{{ r.content }}</textarea>
            <div style="margin-top:8px;text-align:right">
              <button type="button" class="btn btn-danger small" onclick="this.closest('.dynamic-item').remove()">Remove</button>
            </div>
          </div>
          {% endfor %}
        </div>
        <button type="button" class="btn btn-success" onclick="addRCA()" style="margin-top:8px">+ Add RCA</button>
      </div>
    </div>

    <!-- POS TAGGING PANEL -->
    <div class="panel">
      <div class="panel-header" onclick="toggleSection('posPanel')">
        <span class="expand-icon" id="posPanel-icon">‚ñ∂</span>
        <span style="margin-left:8px" class="panel-title">üè∑Ô∏è POS Tagging / Entities</span>
      </div>
      <div id="posPanel-body" class="panel-body">
        <div id="posList">
          {% for p in pos_tagging %}
          <div class="dynamic-item">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div>
                <label class="muted small">Entity Name</label>
                <input type="text" name="pos_name" value="{{ p.name }}" placeholder="e.g., customer_name">
              </div>
              <div>
                <label class="muted small">Reference/Synonym</label>
                <input type="text" name="pos_reference" value="{{ p.reference }}" placeholder="e.g., client, buyer">
              </div>
            </div>
            <div style="margin-top:8px;text-align:right">
              <button type="button" class="btn btn-danger small" onclick="this.closest('.dynamic-item').remove()">Remove</button>
            </div>
          </div>
          {% endfor %}
        </div>
        <button type="button" class="btn btn-success" onclick="addPOS()" style="margin-top:8px">+ Add Entity</button>
      </div>
    </div>

    <!-- METRICS PANEL -->
    <div class="panel">
      <div class="panel-header" onclick="toggleSection('metricsPanel')">
        <span class="expand-icon" id="metricsPanel-icon">‚ñ∂</span>
        <span style="margin-left:8px" class="panel-title">üìä Metrics / KPIs</span>
      </div>
      <div id="metricsPanel-body" class="panel-body">
        <div id="metricsList">
          {% for name, desc in metrics_data.items %}
          <div class="dynamic-item">
            <div style="display:grid;grid-template-columns:1fr 2fr;gap:12px">
              <div>
                <label class="muted small">Metric Name</label>
                <input type="text" name="metric_name" value="{{ name }}" placeholder="e.g., revenue">
              </div>
              <div>
                <label class="muted small">Description / Formula</label>
                <textarea name="metric_desc" rows="2" placeholder="e.g., SUM(amount) - total revenue">{{ desc }}</textarea>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        <button type="button" class="btn btn-success" onclick="addMetric()" style="margin-top:8px">+ Add Metric</button>
      </div>
    </div>

    <!-- EXTRA SUGGESTIONS PANEL -->
    <div class="panel">
      <div class="panel-header" onclick="toggleSection('extraPanel')">
        <span class="expand-icon" id="extraPanel-icon">‚ñ∂</span>
        <span style="margin-left:8px" class="panel-title">üí° Extra Suggestions</span>
      </div>
      <div id="extraPanel-body" class="panel-body">
        <textarea id="extraSuggestions" name="extra_suggestions" rows="4" placeholder="Add any extra context or suggestions for the AI...">{{ extra_suggestions }}</textarea>
      </div>
    </div>

  </form>

  <!-- STICKY BOTTOM BAR -->
  <div class="sticky-bar">
    <div class="sticky-inner">
      <div class="checkbox-group">
        <input type="checkbox" id="runAiCheckbox" checked>
        <label for="runAiCheckbox">ü§ñ Run AI to fill blank descriptions</label>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="statusText" class="muted"></span>
        <a class="btn btn-primary" href="{% url 'chat_module' module.id %}">üí¨ Chat</a>
        <a href="{% url 'dashboard_builder' module.id %}" class="action-btn dashboard-btn" style="
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    ">
        üìä Dashboard Builder
    </a>
        <button type="button" id="saveAllBtn" class="btn btn-ai" onclick="saveAllChanges()">
          üíæ Save & Generate Descriptions
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================== STATE MANAGEMENT ====================
    let selectedColumns = {};
    try {
      selectedColumns = JSON.parse(document.getElementById('selectedColumnsInput').value || "{}");
    } catch(e) { 
      selectedColumns = {}; 
    }
    
    let loadedTables = new Set();
    let tableColumnsCache = {};

    function syncHiddenInput() {
      document.getElementById('selectedColumnsInput').value = JSON.stringify(selectedColumns || {});
      updateSelectionSummary();
    }

    function updateSelectionSummary() {
      const tableCount = Object.keys(selectedColumns).length;
      let columnCount = 0;
      for (const cols of Object.values(selectedColumns)) {
        columnCount += cols.length;
      }
      
      const summaryEl = document.getElementById('selectionSummary');
      if (summaryEl) {
        summaryEl.innerHTML = '<span class="selection-badge">' + tableCount + ' tables, ' + columnCount + ' columns</span>';
      }
    }

    // ==================== PANEL TOGGLING ====================
    function toggleSection(id) {
      const icon = document.getElementById(id + '-icon');
      const body = document.getElementById(id + '-body');
      if (!body) return;

      if (body.style.display === 'block') {
        body.style.display = 'none';
        if (icon) {
          icon.textContent = '‚ñ∂';
          icon.classList.remove('expanded');
        }
      } else {
        body.style.display = 'block';
        if (icon) {
          icon.textContent = '‚ñº';
          icon.classList.add('expanded');
        }
      }
    }

    function toggleKGTable(table) {
      const wrapper = document.getElementById('kg_wrapper_' + table);
      const icon = document.getElementById('kg_icon_' + table);
      if (!wrapper) return;

      if (wrapper.style.display === 'block') {
        wrapper.style.display = 'none';
        if (icon) {
          icon.textContent = '‚ñ∂';
          icon.classList.remove('expanded');
        }
      } else {
        wrapper.style.display = 'block';
        if (icon) {
          icon.textContent = '‚ñº';
          icon.classList.add('expanded');
        }
      }
    }

    // ==================== TABLE/COLUMN LOADING ====================
    async function loadTableColumns(tableName) {
      const container = document.getElementById('columns_' + tableName);
      if (!container) return;

      if (tableColumnsCache[tableName]) {
        renderColumns(tableName, tableColumnsCache[tableName]);
        return;
      }

      container.innerHTML = '<div class="muted small">‚è≥ Loading columns...</div>';

      try {
        const resp = await fetch('/get-table-columns/?table=' + encodeURIComponent(tableName));
        const data = await resp.json();

        if (!data.columns || data.columns.length === 0) {
          container.innerHTML = '<div class="muted small">No columns found</div>';
          return;
        }

        tableColumnsCache[tableName] = data.columns;
        renderColumns(tableName, data.columns);
        loadedTables.add(tableName);

      } catch (e) {
        console.error('Error loading columns for', tableName, e);
        container.innerHTML = '<div class="muted small" style="color:#fca5a5">Error loading columns</div>';
      }
    }

    function renderColumns(tableName, columns) {
      const container = document.getElementById('columns_' + tableName);
      if (!container) return;

      const currentSelection = selectedColumns[tableName] || [];

      let html = '<div style="display:flex;gap:8px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">' +
        '<button type="button" class="btn btn-success small" style="padding:4px 8px;font-size:11px" onclick="selectAllColumnsForTable(\'' + tableName + '\')">All</button>' +
        '<button type="button" class="btn btn-secondary small" style="padding:4px 8px;font-size:11px" onclick="deselectAllColumnsForTable(\'' + tableName + '\')">None</button>' +
        '<span class="muted small" style="margin-left:auto">' + columns.length + ' columns</span></div>';

      for (const col of columns) {
        const colName = col.name;
        const colType = col.type || '';
        const safeId = ('col_' + tableName + '_' + colName).replace(/[^a-zA-Z0-9_]/g, '_');
        const checked = currentSelection.includes(colName) ? 'checked' : '';

        html += '<div class="column-item">' +
          '<input type="checkbox" id="' + safeId + '" value="' + colName + '" ' + checked +
          ' onchange="toggleColumn(\'' + tableName + '\', \'' + colName + '\', this.checked)">' +
          '<label for="' + safeId + '" style="flex:1;cursor:pointer">' + colName + '</label>' +
          '<span class="muted small">' + colType + '</span></div>';
      }

      container.innerHTML = html;
    }

    function toggleTableExpand(tableName) {
      const container = document.getElementById('columns_' + tableName);
      const icon = document.getElementById('expand_' + tableName);
      if (!container) return;

      const isExpanded = container.style.display === 'block';

      if (isExpanded) {
        container.style.display = 'none';
        if (icon) {
          icon.textContent = '‚ñ∂';
          icon.classList.remove('expanded');
        }
      } else {
        if (!loadedTables.has(tableName)) {
          loadTableColumns(tableName).then(function() {
            container.style.display = 'block';
            if (icon) {
              icon.textContent = '‚ñº';
              icon.classList.add('expanded');
            }
          });
        } else {
          container.style.display = 'block';
          if (icon) {
            icon.textContent = '‚ñº';
            icon.classList.add('expanded');
          }
        }
      }
    }

    // ==================== TABLE/COLUMN SELECTION ====================
    function onTableNameClick(tableName, event) {
      event.stopPropagation();
      
      const checkbox = document.querySelector('input[name="selected_tables"][value="' + tableName + '"]');
      
      if (checkbox && !checkbox.checked) {
        checkbox.checked = true;
        loadTableColumns(tableName).then(function() {
          selectAllColumnsForTable(tableName);
          toggleTableExpand(tableName);
        });
      } else {
        toggleTableExpand(tableName);
      }
    }

    function onTableCheckboxChange(checkbox, tableName) {
      const tableItem = checkbox.closest('.table-item');
      
      if (checkbox.checked) {
        if (tableItem) tableItem.classList.add('selected');
        loadTableColumns(tableName).then(function() {
          selectAllColumnsForTable(tableName);
        });
      } else {
        if (tableItem) tableItem.classList.remove('selected');
        deselectAllColumnsForTable(tableName);
      }
    }

    function selectAllColumnsForTable(tableName) {
      const container = document.getElementById('columns_' + tableName);

      if (!container || !loadedTables.has(tableName)) {
        loadTableColumns(tableName).then(function() {
          selectAllColumnsForTable(tableName);
        });
        return;
      }

      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      const cols = [];

      checkboxes.forEach(function(cb) {
        cb.checked = true;
        cols.push(cb.value);
      });

      if (cols.length > 0) {
        selectedColumns[tableName] = Array.from(new Set(cols));
      }

      const tableCheckbox = document.querySelector('input[name="selected_tables"][value="' + tableName + '"]');
      if (tableCheckbox) tableCheckbox.checked = true;

      const tableItem = tableCheckbox ? tableCheckbox.closest('.table-item') : null;
      if (tableItem) tableItem.classList.add('selected');

      syncHiddenInput();
    }

    function deselectAllColumnsForTable(tableName) {
      const container = document.getElementById('columns_' + tableName);

      if (container) {
        container.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
          cb.checked = false;
        });
      }

      delete selectedColumns[tableName];

      const tableCheckbox = document.querySelector('input[name="selected_tables"][value="' + tableName + '"]');
      if (tableCheckbox) tableCheckbox.checked = false;

      const tableItem = tableCheckbox ? tableCheckbox.closest('.table-item') : null;
      if (tableItem) tableItem.classList.remove('selected');

      syncHiddenInput();
    }

    function toggleColumn(tableName, columnName, isChecked) {
      if (!selectedColumns[tableName]) {
        selectedColumns[tableName] = [];
      }

      if (isChecked) {
        if (!selectedColumns[tableName].includes(columnName)) {
          selectedColumns[tableName].push(columnName);
        }
      } else {
        selectedColumns[tableName] = selectedColumns[tableName].filter(function(c) { return c !== columnName; });
        if (selectedColumns[tableName].length === 0) {
          delete selectedColumns[tableName];
        }
      }

      const container = document.getElementById('columns_' + tableName);
      const checkedCount = container ? container.querySelectorAll('input[type="checkbox"]:checked').length : 0;
      const tableCheckbox = document.querySelector('input[name="selected_tables"][value="' + tableName + '"]');

      if (tableCheckbox) {
        tableCheckbox.checked = checkedCount > 0;
        const tableItem = tableCheckbox.closest('.table-item');
        if (tableItem) {
          if (checkedCount > 0) {
            tableItem.classList.add('selected');
          } else {
            tableItem.classList.remove('selected');
          }
        }
      }

      syncHiddenInput();
    }

    // ==================== SELECT/DESELECT ALL ====================
    document.getElementById('selectAllTablesBtn').addEventListener('click', async function() {
      const allCheckboxes = document.querySelectorAll('input[name="selected_tables"]');

      for (const cb of allCheckboxes) {
        if (!cb.checked) {
          cb.checked = true;
          const tableItem = cb.closest('.table-item');
          if (tableItem) tableItem.classList.add('selected');
          await loadTableColumns(cb.value);
          selectAllColumnsForTable(cb.value);
        } else {
          selectAllColumnsForTable(cb.value);
        }
      }
    });

    document.getElementById('deselectAllTablesBtn').addEventListener('click', function() {
      document.querySelectorAll('input[name="selected_tables"]').forEach(function(cb) {
        cb.checked = false;
        deselectAllColumnsForTable(cb.value);
      });
    });

    // ==================== RELATIONSHIP HELPERS ====================
    async function loadColumnsForRelationship(selectEl, side) {
      const tableName = selectEl.value;
      if (!tableName) return;

      const item = selectEl.closest('.relationship-item');
      const columnSelect = item.querySelector('select[name="rel_' + side + '_column"]');
      if (!columnSelect) return;

      columnSelect.innerHTML = '<option>Loading...</option>';

      try {
        let columns = tableColumnsCache[tableName];
        
        if (!columns) {
          const resp = await fetch('/get-table-columns/?table=' + encodeURIComponent(tableName));
          const data = await resp.json();
          columns = data.columns || [];
          tableColumnsCache[tableName] = columns;
        }

        columnSelect.innerHTML = '<option value="">Select column...</option>';
        for (const c of columns) {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          columnSelect.appendChild(opt);
        }

        const savedVal = columnSelect.getAttribute('data-value');
        if (savedVal) columnSelect.value = savedVal;

      } catch (e) {
        console.error(e);
        columnSelect.innerHTML = '<option value="">Error loading</option>';
      }
    }

    function addRelationship() {
      const list = document.getElementById('relationshipsList');
      const selectedTables = Array.from(document.querySelectorAll('input[name="selected_tables"]:checked')).map(function(cb) { return cb.value; });

      let options = '<option value="">Select table...</option>';
      for (const t of selectedTables) {
        options += '<option value="' + t + '">' + t + '</option>';
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'dynamic-item relationship-item';
      wrapper.innerHTML = '<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:start">' +
        '<div><label class="muted small">Left Table</label>' +
        '<select name="rel_left_table" class="rel-select" onchange="loadColumnsForRelationship(this,\'left\')">' + options + '</select>' +
        '<label class="muted small" style="margin-top:8px;display:block">Column</label>' +
        '<select name="rel_left_column" class="rel-select rel-column-select"><option value="">Select column...</option></select></div>' +
        '<div style="text-align:center;padding-top:20px"><label class="muted small">Type</label>' +
        '<select name="rel_type" class="rel-select" style="width:100px">' +
        '<option value="one-to-one">1:1</option><option value="one-to-many" selected>1:N</option>' +
        '<option value="many-to-one">N:1</option><option value="many-to-many">N:N</option></select></div>' +
        '<div><label class="muted small">Right Table</label>' +
        '<select name="rel_right_table" class="rel-select" onchange="loadColumnsForRelationship(this,\'right\')">' + options + '</select>' +
        '<label class="muted small" style="margin-top:8px;display:block">Column</label>' +
        '<select name="rel_right_column" class="rel-select rel-column-select"><option value="">Select column...</option></select></div></div>' +
        '<div style="margin-top:10px;text-align:right"><button type="button" class="btn btn-danger small" onclick="this.closest(\'.relationship-item\').remove()">Remove</button></div>';
      list.appendChild(wrapper);
    }

    // ==================== DYNAMIC LIST ADDERS ====================
    function addRCA() {
      const list = document.getElementById('rcaList');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = '<input type="text" name="rca_title" placeholder="RCA Title" style="margin-bottom:8px">' +
        '<textarea name="rca_content" placeholder="RCA Content" rows="3"></textarea>' +
        '<div style="margin-top:8px;text-align:right"><button type="button" class="btn btn-danger small" onclick="this.closest(\'.dynamic-item\').remove()">Remove</button></div>';
      list.appendChild(item);
    }

    function addPOS() {
      const list = document.getElementById('posList');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
        '<div><label class="muted small">Entity Name</label><input type="text" name="pos_name" placeholder="e.g., customer_name"></div>' +
        '<div><label class="muted small">Reference/Synonym</label><input type="text" name="pos_reference" placeholder="e.g., client, buyer"></div></div>' +
        '<div style="margin-top:8px;text-align:right"><button type="button" class="btn btn-danger small" onclick="this.closest(\'.dynamic-item\').remove()">Remove</button></div>';
      list.appendChild(item);
    }

    function addMetric() {
      const list = document.getElementById('metricsList');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = '<div style="display:grid;grid-template-columns:1fr 2fr;gap:12px">' +
        '<div><label class="muted small">Metric Name</label><input type="text" name="metric_name" placeholder="e.g., revenue"></div>' +
        '<div><label class="muted small">Description / Formula</label><textarea name="metric_desc" rows="2" placeholder="e.g., SUM(amount) - total revenue"></textarea></div></div>';
      list.appendChild(item);
    }

    // ==================== SAVE FUNCTION ====================
    async function saveAllChanges() {
      const saveBtn = document.getElementById('saveAllBtn');
      const statusText = document.getElementById('statusText');
      const form = document.getElementById('mainForm');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const runAiCheckbox = document.getElementById('runAiCheckbox');
      const originalText = saveBtn.innerHTML;

      try {
        saveBtn.disabled = true;
        
        // Check if AI should run
        const runAi = runAiCheckbox.checked;
        document.getElementById('runAiInput').value = runAi ? 'true' : 'false';
        
        if (runAi) {
          saveBtn.innerHTML = 'ü§ñ Running AI...';
          loadingOverlay.style.display = 'flex';
        } else {
          saveBtn.innerHTML = '‚è≥ Saving...';
        }
        
        if (statusText) statusText.textContent = runAi ? 'Generating AI descriptions...' : 'Saving changes...';

        // Sync selected columns
        syncHiddenInput();

        // Ensure action is set
        let actionInput = form.querySelector('input[name="action"]');
        if (!actionInput) {
          actionInput = document.createElement('input');
          actionInput.type = 'hidden';
          actionInput.name = 'action';
          form.appendChild(actionInput);
        }
        actionInput.value = 'save_all';

        // Submit via fetch
        const fd = new FormData(form);
        const csrf = document.querySelector('[name="csrfmiddlewaretoken"]');
        if (csrf && !fd.has('csrfmiddlewaretoken')) {
          fd.append('csrfmiddlewaretoken', csrf.value);
        }

        const resp = await fetch(window.location.href, {
          method: 'POST',
          body: fd,
          credentials: 'same-origin'
        });

        if (!resp.ok && resp.status !== 302) {
          const text = await resp.text();
          console.error('Save failed:', resp.status, text);
          alert('Failed to save. Please check the console for details.');
          saveBtn.innerHTML = '‚ùå Error';
          if (statusText) statusText.textContent = 'Error saving';
          return;
        }

        saveBtn.innerHTML = '‚úÖ Saved!';
        if (statusText) statusText.textContent = runAi ? 'AI descriptions generated!' : 'All changes saved!';
        
        // Reload to show updated KG with AI-generated descriptions
        setTimeout(function() { location.reload(); }, 800);

      } catch (e) {
        console.error('Save error:', e);
        alert('Error saving: ' + (e.message || e));
        saveBtn.innerHTML = '‚ùå Error';
        if (statusText) statusText.textContent = 'Error saving';
      } finally {
        loadingOverlay.style.display = 'none';
        setTimeout(function() {
          try {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
          } catch (e) {}
        }, 2000);
      }
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      // Load columns for initially selected tables
      document.querySelectorAll('input[name="selected_tables"]:checked').forEach(function(cb) {
        loadTableColumns(cb.value);
      });

      // Initialize relationship column dropdowns
      document.querySelectorAll('.relationship-item').forEach(function(item) {
        const leftTable = item.querySelector('select[name="rel_left_table"]');
        const rightTable = item.querySelector('select[name="rel_right_table"]');
        if (leftTable && leftTable.value) {
          loadColumnsForRelationship(leftTable, 'left');
        }
        if (rightTable && rightTable.value) {
          loadColumnsForRelationship(rightTable, 'right');
        }
      });

      // Update summary
      updateSelectionSummary();

      // Sync form on submit
      document.getElementById('mainForm').addEventListener('submit', function() {
        syncHiddenInput();
      });
    });
  </script>
</body>
</html>