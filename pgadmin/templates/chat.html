<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Assistant - Data Query Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .typing-indicator::after {
      content: '...';
      animation: typing 1.5s infinite;
    }
    @keyframes typing {
      0%, 60%, 100% { opacity: 0; }
      30% { opacity: 1; }
    }
    .message-animation {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .option-btn:hover {
      transform: translateX(4px);
      transition: all 0.2s;
    }
  </style>
</head>
<body class="bg-gray-50 flex flex-col h-screen">

<!-- Header -->
<div class="bg-white shadow-sm border-b px-6 py-4">
  <h1 class="text-xl font-semibold text-gray-800">Data Query Assistant</h1>
  <p class="text-sm text-gray-500">Ask questions about your data</p>
</div>

<!-- Chat Container -->
<div class="flex-1 overflow-y-auto p-6" id="chat-box">
  <div class="max-w-3xl mx-auto">
    <!-- Welcome Message -->
    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <p class="text-blue-700 font-medium">
        ðŸ‘‹ Welcome! I can help you query your database.
      </p>
      <ul class="text-sm text-blue-600 mt-2 ml-4 list-disc">
        <li>Sales data for distributors or products</li>
        <li>Shipment information for parties</li>
        <li>Product performance metrics</li>
      </ul>
      <p class="text-xs text-blue-500 mt-2">
        ðŸ’¡ If I'm unsure about what you mean, I'll ask you to clarify!
      </p>
    </div>
  </div>
</div>

<!-- Typing Indicator -->
<div id="typing-indicator" class="hidden px-6 pb-2">
  <div class="max-w-3xl mx-auto">
    <div class="text-gray-500 text-sm typing-indicator">Assistant is typing</div>
  </div>
</div>

<!-- Input Area -->
<div class="bg-white border-t p-4">
  <div class="max-w-3xl mx-auto flex gap-2">
    <input 
      id="message-input" 
      class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
      placeholder="Type your question here... (e.g., 'sales for VH trading')"
      disabled
    />
    <button 
      id="send-btn" 
      class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
      disabled
    >
      Send
    </button>
  </div>
</div>

<!-- Session Info -->
<div id="session-info" class="hidden fixed bottom-4 right-4 bg-white p-3 rounded-lg shadow-lg text-xs border">
  <div class="font-semibold mb-1 text-gray-700">Session Context:</div>
  <div id="session-entities" class="text-gray-600"></div>
</div>

<script>
// ==================== CONFIGURATION ====================
const API_URL = "/api/chat/";

// ==================== CSRF TOKEN ====================
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// ==================== STATE MANAGEMENT ====================
let isProcessing = false;
let sessionEntities = {};
let currentClarification = null;

// ==================== UI HELPER FUNCTIONS ====================
function addMessage(content, isUser = false, type = 'normal') {
  const chatBox = document.getElementById("chat-box");
  const messageContainer = chatBox.querySelector('.max-w-3xl');
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `mb-4 message-animation ${isUser ? 'text-right' : 'text-left'}`;
  
  let bgColor = isUser ? 'bg-blue-600 text-white' : 'bg-white border border-gray-200';
  if (type === 'error') bgColor = 'bg-red-50 border border-red-200 text-red-700';
  if (type === 'clarification') bgColor = 'bg-yellow-50 border border-yellow-300';
  
  messageDiv.innerHTML = `
    <div class="inline-block max-w-xl ${bgColor} rounded-lg px-4 py-3 shadow-sm">
      ${content}
    </div>
  `;
  
  messageContainer.appendChild(messageDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
  return messageDiv;
}

function showTyping(show = true) {
  document.getElementById('typing-indicator').classList.toggle('hidden', !show);
  if (show) {
    document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
  }
}

function setInputState(enabled = true) {
  const input = document.getElementById('message-input');
  const button = document.getElementById('send-btn');
  input.disabled = !enabled;
  button.disabled = !enabled;
  isProcessing = !enabled;
  if (enabled) input.focus();
}

function updateSessionInfo() {
  const sessionDiv = document.getElementById('session-entities');
  if (Object.keys(sessionEntities).length > 0) {
    sessionDiv.innerHTML = Object.entries(sessionEntities)
      .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
      .join('');
    document.getElementById('session-info').classList.remove('hidden');
  }
}

// ==================== MAIN SEND MESSAGE FUNCTION ====================
async function sendMessage(msg = null, feedback = null) {
  if (isProcessing) return;
  
  const messageInput = document.getElementById("message-input");
  
  // Get message from input or parameter
  if (!msg && !feedback) {
    msg = messageInput.value.trim();
  }
  
  if (!msg && !feedback) return;
  
  // Show user message (not for feedback responses)
  if (!feedback) {
    addMessage(escapeHtml(msg), true);
    messageInput.value = "";
  }
  
  // Disable input and show typing
  setInputState(false);
  showTyping(true);
  
  try {
    const response = await fetch(API_URL, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify(feedback ? { feedback } : { message: msg }),
    });
    
    showTyping(false);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Handle different response types
    if (data.type === "clarification") {
      currentClarification = data;
      
      if (data.subtype === "column") {
        handleColumnClarification(data);
      } else {
        handleValueClarification(data);
      }
    } else if (data.type === "error") {
      addMessage(escapeHtml(data.message), false, 'error');
    } else {
      // Normal response
      addMessage(formatMessage(data.message), false);
      
      // Update session entities
      if (data.entities) {
        sessionEntities = { ...sessionEntities, ...data.entities };
        updateSessionInfo();
      }
      
      // Handle chart if provided
      if (data.chart) {
        displayChart(data.chart);
      }
    }
    
  } catch (error) {
    console.error("Error:", error);
    showTyping(false);
    addMessage("Sorry, I encountered an error. Please try again.", false, 'error');
  } finally {
    setInputState(true);
  }
}

// ==================== COLUMN CLARIFICATION ====================
function handleColumnClarification(data) {
  const clarificationDiv = addMessage('', false, 'clarification');
  
  const optionsHtml = data.options.map((opt, idx) => `
    <button 
      class="option-btn block w-full text-left px-4 py-3 mb-2 bg-white hover:bg-blue-50 border-2 border-gray-300 hover:border-blue-400 rounded-md transition-all"
      onclick="selectColumn('${escapeJs(data.entity_type)}', '${escapeJs(data.entity)}', '${escapeJs(opt.table)}', '${escapeJs(opt.column)}', ${idx})"
    >
      <div class="font-semibold text-gray-800">
        <span class="text-blue-600 font-bold">${idx + 1}.</span> ${escapeHtml(opt.column)}
      </div>
      <div class="text-sm text-gray-600 mt-1">
        Table: ${escapeHtml(opt.table)} | Best match: "${escapeHtml(opt.best_match)}" (${opt.count} total)
      </div>
    </button>
  `).join('');
  
  clarificationDiv.querySelector('div').innerHTML = `
    <div class="font-semibold mb-3 text-gray-800">
      ðŸ”€ ${escapeHtml(data.message)}
    </div>
    <div class="mt-2">
      ${optionsHtml}
    </div>
    <div class="text-xs text-gray-500 mt-3">
      Select the column you meant
    </div>
  `;
}

// ==================== VALUE CLARIFICATION (WITH "SEE MORE" AND CUSTOM INPUT) ====================
function handleValueClarification(data) {
  const clarificationDiv = addMessage('', false, 'clarification');
  
  const optionsHtml = data.options.map((opt, idx) => `
    <button 
      class="option-btn block w-full text-left px-4 py-2.5 mb-2 bg-white hover:bg-blue-50 border-2 border-gray-300 hover:border-blue-400 rounded-md transition-all text-gray-700 hover:text-blue-700 font-medium"
      onclick="selectValue('${escapeJs(data.entity_type)}', '${escapeJs(opt)}', ${idx})"
    >
      <span class="text-blue-600 font-bold">${idx + 1}.</span> ${escapeHtml(opt)}
    </button>
  `).join('');
  
  // Show "See more" if there are additional results
  const seeMoreHtml = data.has_more ? `
    <div class="text-center my-2">
      <button 
        class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded border border-gray-300"
        onclick="alert('Showing ${data.options.length} of ${data.total_count} results. Please refine your search or select from above.')"
      >
        ðŸ“‹ See More (${data.options.length} of ${data.total_count} shown)
      </button>
    </div>
  ` : '';
  
  // "None of these" with custom input
  const customInputHtml = `
    <div class="mt-3 pt-3 border-t border-gray-300">
      <div class="text-sm text-gray-600 mb-2 font-medium">
        None of these? Type your own:
      </div>
      <div class="flex gap-2">
        <input 
          id="custom-entity-input" 
          type="text" 
          class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Type exact ${escapeHtml(data.entity_type)} name..."
        />
        <button 
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium text-sm"
          onclick="submitCustomValue('${escapeJs(data.entity_type)}')"
        >
          âœ“ Submit
        </button>
      </div>
    </div>
  `;
  
  clarificationDiv.querySelector('div').innerHTML = `
    <div class="font-semibold mb-3 text-gray-800">
      ðŸ¤” ${escapeHtml(data.message)}
    </div>
    <div class="mt-2">
      ${optionsHtml}
      ${seeMoreHtml}
      ${customInputHtml}
    </div>
    <div class="text-xs text-gray-500 mt-2">
      Click an option or type your own
    </div>
  `;
}

// ==================== SELECTION HANDLERS ====================
function selectColumn(entityType, entity, table, column, index) {
  disableAllButtons();
  highlightButton(index);
  
  addMessage(`Selected column: ${column} in ${table}`, true);
  
  sendMessage(null, {
    type: "column_selection",
    entity_type: entityType,
    entity: entity,
    selected_table: table,
    selected_column: column
  });
}

function selectValue(entityType, selectedValue, index) {
  disableAllButtons();
  highlightButton(index);
  
  addMessage(`âœ… Selected: ${escapeHtml(selectedValue)}`, true);
  
  sendMessage(null, {
    type: "value_selection",
    entity_type: entityType,
    selected_option: selectedValue
  });
}

function submitCustomValue(entityType) {
  const input = document.getElementById('custom-entity-input');
  const customValue = input.value.trim();
  
  if (!customValue) {
    alert("Please enter a value");
    return;
  }
  
  disableAllButtons();
  input.disabled = true;
  
  addMessage(`âœï¸ Custom input: ${escapeHtml(customValue)}`, true);
  
  sendMessage(null, {
    type: "custom_input",
    entity_type: entityType,
    custom_value: customValue
  });
}

// ==================== UTILITY FUNCTIONS ====================
function disableAllButtons() {
  document.querySelectorAll('.option-btn').forEach(btn => {
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
  });
}

function highlightButton(index) {
  const buttons = document.querySelectorAll('.option-btn');
  if (buttons[index]) {
    buttons[index].classList.remove('border-gray-300');
    buttons[index].classList.add('border-green-500', 'bg-green-50');
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function escapeJs(text) {
  return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
}

function formatMessage(message) {
  return message
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>');
}

// ==================== CHART DISPLAY ====================
function displayChart(chartData) {
  const chartDiv = document.createElement('div');
  chartDiv.className = 'mb-4 message-animation';
  chartDiv.innerHTML = `
    <div class="inline-block max-w-xl bg-white border rounded-lg p-4 shadow-sm">
      <div class="text-sm text-gray-600 mb-2 font-medium">ðŸ“Š Chart Data:</div>
      <div class="text-center text-gray-500 bg-gray-50 p-4 rounded">
        [Chart visualization would appear here]
        <pre class="mt-2 text-xs text-left overflow-auto">${JSON.stringify(chartData, null, 2)}</pre>
      </div>
    </div>
  `;
  document.getElementById('chat-box').querySelector('.max-w-3xl').appendChild(chartDiv);
  document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
}

// ==================== EVENT LISTENERS ====================
document.getElementById("send-btn").addEventListener("click", () => sendMessage());

document.getElementById("message-input").addEventListener("keypress", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// ==================== INITIALIZATION ====================
window.addEventListener('load', () => {
  setInputState(true);
  document.getElementById('message-input').focus();
});
</script>

</body>
</html>